ssl_certificate /run/secrets/cert.pem;
ssl_certificate_key /run/secrets/key.pem;

ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers HIGH:!aNULL:MD5;

add_header Allow "GET, POST, PATCH, DELETE" always;
add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE" always;
add_header Accept-Patch "application/json-patch+json" always;	

location / {
	proxy_pass http://frontend:1212;
	
	# security headers
	add_header Content-Security-Policy "script-src 'self'; style-src 'self'; object-src 'self'; base-URI 'self';" always;
	add_header Cross-Origin-Resource-Policy "same-origin" always;
	add_header Referer-Policy "strict-origin-when-cross-origin" always;
	add_header X-Content-Type-Options "nosniff" always;


	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;

	#proxy headers
	proxy_method $request_method;
	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection $connection_upgrade;
	proxy_set_header Host $host;
	proxy_set_header X-Real-IP $remote_addr;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto $scheme;
	proxy_cache_bypass $http_upgrade;
	proxy_read_timeout 300s;
	proxy_send_timeout 300s;
	proxy_connect_timeout 75s;

	if ($request_method = 'OPTIONS') {
		return 204;
	}
}

location /api/bff/ {
	proxy_pass http://bff:1818/;

	add_header Content-Type "application/json charset=utf-8" always;

	# security headers
	
	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;

	#proxy headers
	proxy_method $request_method;
	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection $connection_upgrade;
	proxy_set_header Host $host;
	proxy_set_header X-Real-IP $remote_addr;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto $scheme;

	if ($request_method = 'OPTIONS') {
		return 204;
	}
}

location /api/auth/ {
	proxy_pass http://auth:3939/;

	add_header Content-Type "application/json charset=utf-8" always;
	

	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;

	if ($request_method = 'OPTIONS') {
		return 204;
	}
}

# handles users management system (user search and database interaction)
location /api/users/ {
	proxy_pass http://users:2626/;

	add_header Content-Type "application/json charset=utf-8" always;

	if ($request_method = 'OPTIONS') {
		return 204;
	}

	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;
}

# these will eventually become NATS subscribers
# they are not part of the HTTP API documentation
location /api/game/statistics {
	proxy_pass http://dashboard:1515/;

	add_header Content-Type "application/json charset=utf-8" always;

	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;

	if ($request_method = 'OPTIONS') {
		return 204;
	}
}

location /api/friends/ {
	proxy_pass http://friends:1616/;

	add_header Content-Type "application/json charset=utf-8" always;

	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;

	if ($request_method = 'OPTIONS') {
		return 204;
	}
}

location /api/lobby/ {
	proxy_pass http://game-manager:2121;

	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;

	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection $connection_upgrade;
	proxy_set_header Host $host;
	proxy_set_header X-Real-IP $remote_addr;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto $scheme;
	proxy_cache_bypass $http_upgrade;
	proxy_read_timeout 300s;
	proxy_send_timeout 300s;
	proxy_connect_timeout 75s;

	if ($request_method = 'OPTIONS') {
		return 204;
	}
}

location /api/game/ {
	proxy_pass http://pong:2020;

	add_header Access-Control-Allow-Origin $cors_origin always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
	add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
	add_header Access-Control-Allow-Credentials "true" always;

	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection $connection_upgrade;
	proxy_set_header Host $host;
	proxy_set_header X-Real-IP $remote_addr;
	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	proxy_set_header X-Forwarded-Proto $scheme;
	proxy_cache_bypass $http_upgrade;
	# proxy_read_timeout 30s;
	# proxy_send_timeout 30s;
	# proxy_connect_timeout 75s;

	if ($request_method = 'OPTIONS') {
		return 204;
	}
}