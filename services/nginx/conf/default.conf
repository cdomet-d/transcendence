map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 0.0.0.0:443 ssl;
    listen 0.0.0.0:80;
	server_name localhost z1r2p3;

	ssl_certificate /run/secrets/cert.pem;
	ssl_certificate_key /run/secrets/key.pem;

	ssl_protocols TLSv1.2 TLSv1.3;
	ssl_ciphers HIGH:!aNULL:MD5;

	add_header Allow "GET, POST, PATCH, DELETE" always;
	add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE" always;
	add_header Accept-Patch "application/json-patch+json" always;	

    location / {
        proxy_pass http://frontend:1212;
		
		# security headers
		add_header X-Content-Type-Options "nosniff" always;
		add_header Cross-Origin-Resource-Policy "same-origin" always;
		add_header Referer-Policy "strict-origin-when-cross-origin" always;


		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;

		#proxy headers
		proxy_method $request_method;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
		proxy_cache_bypass $http_upgrade;
		proxy_read_timeout 300s;
		proxy_send_timeout 300s;
		proxy_connect_timeout 75s;

		if ($request_method = 'OPTIONS') {
			return 204;
		}
	}

	location /api/bff/ {
		proxy_pass http://bff:1818/;

		add_header Content-Type "application/json charset=utf-8" always;

		# security headers
		
		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;

		#proxy headers
		proxy_method $request_method;
		proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

		if ($request_method = 'OPTIONS') {
			return 204;
		}
	}

	location /api/auth/ {
		proxy_pass http://auth:3939/;

		add_header Content-Type "application/json charset=utf-8" always;
		

		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;

		if ($request_method = 'OPTIONS') {
			return 204;
		}
	}

	# handles users management system (user search and database interaction)
	location /api/users/ {
		proxy_pass http://users:2626/;

		add_header Content-Type "application/json charset=utf-8" always;

		if ($request_method = 'OPTIONS') {
			return 204;
		}

		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;
	}

	# these will eventually become NATS subscribers
	# they are not part of the HTTP API documentation
	location /api/game/statistics {
		proxy_pass http://dashboard:1515/;

		add_header Content-Type "application/json charset=utf-8" always;

		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;

		if ($request_method = 'OPTIONS') {
			return 204;
		}
	}

	location /api/friends/ {
		proxy_pass http://friends:1616/;

		add_header Content-Type "application/json charset=utf-8" always;

		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;

		if ($request_method = 'OPTIONS') {
			return 204;
		}
	}

	location /api/lobby/ {
		proxy_pass http://game-manager:2121;

		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
		proxy_cache_bypass $http_upgrade;
		proxy_read_timeout 300s;
		proxy_send_timeout 300s;
		proxy_connect_timeout 75s;

		if ($request_method = 'OPTIONS') {
			return 204;
		}
    }

    location /api/game/ {
		proxy_pass http://pong:2020;

		add_header Access-Control-Allow-Origin "https://z1r2p3:8443" always;
		add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
		add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
		add_header Access-Control-Allow-Credentials "true" always;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
		proxy_cache_bypass $http_upgrade;
		proxy_read_timeout 300s;
		proxy_send_timeout 300s;
		proxy_connect_timeout 75s;

		if ($request_method = 'OPTIONS') {
			return 204;
		}
    }

    # error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    # error_page   500 502 503 504  /50x.html;
    # location = /50x.html {
    #     root   /usr/share/nginx/html/;
    # }
}

# sript-src 'self'; 
		# only external scripts loaded from localhost:8443 are 
		# allowed to execute.
			# Blocks inline javascript from executing, avoiding XSS 
			# attacks if injected scripts escape sanitization.
				# If we do need inline javascript or event listeners,
				# we can reenable it by implementing nonces.
				# Nonces are randomly generated values that the server 
				# includes in every HTTP header response and sets in 
				# inline or external scripts.
				# Ex: <script nonce="val"> ... script ... </script>
				# The browser then matches the value in the header with 
				# the attribute value and executes the script only if 
				# the two match.
				# It sounds heavy weight and complex, so for now we 
				# have localisation based-safety instead of that; 
				# it MAY change as we need it.
	
	# style-src 'self'; 
		# same for CSS (not sure if needed)
	# img-src 'http://cdn.com'
		# we don't have a CDN yet, so not adding that, but we will need it later to allow images to load. 
	# object-src 'self';
		# Blocks external objects embeds 
	# base-URI 'self';
		# Makes so that the < base > HTML tag defaults the our servername.

# forbids browser from guessing the content type of a payload, limiting 
# innocent or malicious misinterpretations.